package com.redhat.ecosystemappeng.service.osv;

import java.util.List;

import com.redhat.ecosystemappeng.model.Vulnerability;

import io.quarkus.mongodb.panache.PanacheMongoRepositoryBase;
import io.quarkus.mongodb.panache.common.ProjectionFor;
import jakarta.enterprise.context.ApplicationScoped;

@ApplicationScoped
public class VulnerabilityRepository implements PanacheMongoRepositoryBase<Vulnerability, String> {

    public Vulnerability findByVulnId(String vulnId) {
        return find("vulnId", vulnId).firstResult();
    }

    public Vulnerability findByCve(String cve) {
        return find("cve", cve).firstResult();
    }

    public List<VulnerabilityId> findAllIds() {
        return findAll().project(VulnerabilityId.class).list();
    }

    public List<Vulnerability> findByPurl(String purl) {
        //return find("{'osvRaw': {'affected': {'package': {'purl': ?1}}}}", purl).list();
        return find("osvRaw.affected.package.purl = ?1", purl).list();
    }

    @ProjectionFor(Vulnerability.class)
    public static class VulnerabilityId {
        public String vulnId;
    }

}
